<Window x:Class="WPFUI_NEW.Views.HostOverlayWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:WPFUI_NEW.ViewModels"
        mc:Ignorable="d"
        Title="HostOverlay" Height="200" Width="600"
        WindowStyle="None" AllowsTransparency="True" Background="Transparent"
        Topmost="True" ShowInTaskbar="False" ResizeMode="NoResize"
        d:DataContext="{d:DesignInstance vm:HostViewModel, IsDesignTimeCreatable=True}">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <Style x:Key="StatLabel" TargetType="TextBlock">
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="Foreground" Value="#94A3B8"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
        </Style>
        <Style x:Key="StatValue" TargetType="TextBlock">
            <Setter Property="FontSize" Value="13"/>
            <Setter Property="FontWeight" Value="Bold"/>
            <Setter Property="Foreground" Value="#E2E8F0"/>
            <Setter Property="HorizontalAlignment" Value="Center"/>
            <Setter Property="FontFamily" Value="Consolas, Courier New"/>
        </Style>
        <Style x:Key="Separator" TargetType="Rectangle">
            <Setter Property="Width" Value="1"/>
            <Setter Property="Height" Value="20"/>
            <Setter Property="Fill" Value="#334155"/>
            <Setter Property="Margin" Value="10,0"/>
        </Style>
    </Window.Resources>

    <Grid VerticalAlignment="Top">

        <Border x:Name="HostBar"
                Background="#F20F172A"
                BorderBrush="#4D38BD" BorderThickness="1"
                CornerRadius="12"
                HorizontalAlignment="Center" VerticalAlignment="Top"
                Margin="0,20,0,0"
                Padding="15,8">

            <Border.Effect>
                <DropShadowEffect ShadowDepth="5" BlurRadius="20" Opacity="0.6"/>
            </Border.Effect>

            <Border.Style>
                <Style TargetType="Border">
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsOverlayVisible}" Value="False">
                            <DataTrigger.EnterActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetProperty="Opacity" To="0" Duration="0:0:0.3"/>
                                        <ThicknessAnimation Storyboard.TargetProperty="Margin" To="0,-100,0,0" Duration="0:0:0.4">
                                            <ThicknessAnimation.EasingFunction>
                                                <BackEase EasingMode="EaseIn" Amplitude="0.3"/>
                                            </ThicknessAnimation.EasingFunction>
                                        </ThicknessAnimation>
                                    </Storyboard>
                                </BeginStoryboard>
                            </DataTrigger.EnterActions>
                            <DataTrigger.ExitActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetProperty="Opacity" To="1" Duration="0:0:0.3"/>
                                        <ThicknessAnimation Storyboard.TargetProperty="Margin" To="0,20,0,0" Duration="0:0:0.4">
                                            <ThicknessAnimation.EasingFunction>
                                                <BackEase EasingMode="EaseOut" Amplitude="0.3"/>
                                            </ThicknessAnimation.EasingFunction>
                                        </ThicknessAnimation>
                                    </Storyboard>
                                </BeginStoryboard>
                            </DataTrigger.ExitActions>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>

            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">

                <Border Background="Transparent" Cursor="SizeAll" MouseLeftButtonDown="DragHandle_MouseDown" Margin="0,0,10,0">
                    <TextBlock Text="::" Foreground="#475569" FontSize="14" FontWeight="Bold" VerticalAlignment="Center"/>
                </Border>

                <Border Background="#EF4444" CornerRadius="4" Padding="6,2" Margin="0,0,15,0">
                    <Border.Triggers>
                        <EventTrigger RoutedEvent="Border.Loaded">
                            <BeginStoryboard>
                                <Storyboard RepeatBehavior="Forever" AutoReverse="True">
                                    <DoubleAnimation Storyboard.TargetProperty="Opacity" From="1.0" To="0.6" Duration="0:0:1"/>
                                </Storyboard>
                            </BeginStoryboard>
                        </EventTrigger>
                    </Border.Triggers>
                    <StackPanel Orientation="Horizontal">
                        <TextBlock Text="●" Foreground="White" FontSize="10" Margin="0,0,4,0" VerticalAlignment="Center"/>
                        <TextBlock Text="LIVE" Foreground="White" FontSize="10" FontWeight="Bold" VerticalAlignment="Center"/>
                    </StackPanel>
                </Border>

                <StackPanel>
                    <TextBlock Text="60" Style="{StaticResource StatValue}"/>
                    <TextBlock Text="FPS" Style="{StaticResource StatLabel}"/>
                </StackPanel>

                <Rectangle Style="{StaticResource Separator}"/>

                <StackPanel>
                    <TextBlock Text="{Binding HostBitrateText}" Style="{StaticResource StatValue}"/>
                    <TextBlock Text="Mb/s" Style="{StaticResource StatLabel}"/>
                </StackPanel>

                <Rectangle Style="{StaticResource Separator}"/>

                <ToggleButton x:Name="BtnClients" Background="Transparent" BorderThickness="0" Cursor="Hand" Padding="5,0">
                    <ToggleButton.Template>
                        <ControlTemplate TargetType="ToggleButton">
                            <StackPanel Background="Transparent">
                                <TextBlock Text="{Binding ClientCount}" Style="{StaticResource StatValue}" Foreground="#38BDF8"/>
                                <StackPanel Orientation="Horizontal" HorizontalAlignment="Center">
                                    <TextBlock Text="Clients" Style="{StaticResource StatLabel}"/>
                                    <TextBlock Text="▼" FontSize="8" Foreground="#94A3B8" Margin="3,2,0,0" VerticalAlignment="Center"/>
                                </StackPanel>
                            </StackPanel>
                        </ControlTemplate>
                    </ToggleButton.Template>
                </ToggleButton>

                <Popup IsOpen="{Binding IsChecked, ElementName=BtnClients}" StaysOpen="False" PlacementTarget="{Binding ElementName=BtnClients}" Placement="Bottom" VerticalOffset="10" AllowsTransparency="True">
                    <Border Background="#1E293B" BorderBrush="#334155" BorderThickness="1" CornerRadius="8" Padding="5" MinWidth="200">
                        <Border.Effect>
                            <DropShadowEffect ShadowDepth="5" BlurRadius="10" Opacity="0.5"/>
                        </Border.Effect>

                        <StackPanel>
                            <TextBlock Text="DANH SÁCH KẾT NỐI" Foreground="#64748B" FontSize="10" FontWeight="Bold" Margin="5,5,5,10"/>

                            <ItemsControl ItemsSource="{Binding ConnectedClients}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Background="#0F172A" CornerRadius="4" Padding="8" Margin="0,0,0,5">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <StackPanel Grid.Column="0" VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding DisplayName}" Foreground="White" FontWeight="SemiBold" FontSize="13" TextTrimming="CharacterEllipsis"/>
                                                    <TextBlock Text="{Binding ClientIP}" Foreground="#94A3B8" FontSize="11"/>
                                                </StackPanel>

                                                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center">

                                                    <Button Command="{Binding DataContext.ToggleMuteClientCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                            CommandParameter="{Binding}"
                                                            Margin="0,0,5,0" Width="30" Height="30" BorderThickness="0" Cursor="Hand"
                                                            ToolTip="Bật/Tắt Mic">
                                                        <Button.Style>
                                                            <Style TargetType="Button">
                                                                <Setter Property="Background" Value="#334155"/>
                                                                <Setter Property="Template">
                                                                    <Setter.Value>
                                                                        <ControlTemplate TargetType="Button">
                                                                            <Border Background="{TemplateBinding Background}" CornerRadius="4">
                                                                                <ContentPresenter HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                            </Border>
                                                                        </ControlTemplate>
                                                                    </Setter.Value>
                                                                </Setter>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding IsMuted}" Value="True">
                                                                        <Setter Property="Background" Value="#EF4444"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </Button.Style>
                                                        <TextBlock FontFamily="Segoe MDL2 Assets" FontSize="14" Foreground="White">
                                                            <TextBlock.Style>
                                                                <Style TargetType="TextBlock">
                                                                    <Setter Property="Text" Value="&#xE720;"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsMuted}" Value="True">
                                                                            <Setter Property="Text" Value="&#xE721;"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </TextBlock.Style>
                                                        </TextBlock>
                                                    </Button>

                                                    <Button Command="{Binding DataContext.KickClientCommand, RelativeSource={RelativeSource AncestorType=Window}}" 
                                                            CommandParameter="{Binding}"
                                                            Width="30" Height="30" Background="#33EF4444" BorderThickness="0" Cursor="Hand"
                                                            ToolTip="Đuổi (Kick)">
                                                        <Button.Template>
                                                            <ControlTemplate TargetType="Button">
                                                                <Border Background="{TemplateBinding Background}" CornerRadius="4">
                                                                    <TextBlock Text="&#xE711;" FontFamily="Segoe MDL2 Assets" FontSize="14" Foreground="#EF4444" 
                                                                               HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                                                </Border>
                                                            </ControlTemplate>
                                                        </Button.Template>
                                                    </Button>

                                                </StackPanel>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>

                            <TextBlock Text="Chưa có client kết nối" FontStyle="Italic" Foreground="#64748B" HorizontalAlignment="Center" Margin="10">
                                <TextBlock.Style>
                                    <Style TargetType="TextBlock">
                                        <Setter Property="Visibility" Value="Collapsed"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding ClientCount}" Value="0">
                                                <Setter Property="Visibility" Value="Visible"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </TextBlock.Style>
                            </TextBlock>
                        </StackPanel>
                    </Border>
                </Popup>

                <Rectangle Style="{StaticResource Separator}"/>

                <Button Command="{Binding ToggleOverlayCommand}" Background="Transparent" BorderThickness="0" Cursor="Hand" ToolTip="Ẩn Dashboard (Ctrl+H)">
                    <TextBlock Text="&#xE70E;" FontFamily="Segoe MDL2 Assets" Foreground="#94A3B8" FontSize="14"/>
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border x:Name="bd" Background="{TemplateBinding Background}" CornerRadius="4" Padding="5">
                                            <ContentPresenter/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="bd" Property="Background" Value="#1AFFFFFF"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Button.Style>
                </Button>

                <Button Command="{Binding StartStreamCommand}" Content="■ Stop" Margin="15,0,0,0" Cursor="Hand">
                    <Button.Style>
                        <Style TargetType="Button">
                            <Setter Property="Background" Value="#1AEF4444"/>
                            <Setter Property="Foreground" Value="#EF4444"/>
                            <Setter Property="FontWeight" Value="SemiBold"/>
                            <Setter Property="BorderBrush" Value="#4DEF4444"/>
                            <Setter Property="BorderThickness" Value="1"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="Button">
                                        <Border x:Name="bd" Background="{TemplateBinding Background}" 
                                                BorderBrush="{TemplateBinding BorderBrush}" BorderThickness="{TemplateBinding BorderThickness}"
                                                CornerRadius="6" Padding="12,6">
                                            <ContentPresenter HorizontalAlignment="Center"/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="bd" Property="Background" Value="#EF4444"/>
                                                <Setter Property="Foreground" Value="White"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </Button.Style>
                </Button>

            </StackPanel>
        </Border>

        <Border Background="#CC0F172A" CornerRadius="20" Padding="12,4" HorizontalAlignment="Center" VerticalAlignment="Top" Margin="0,10,0,0" IsHitTestVisible="False" BorderBrush="#334155" BorderThickness="1">
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Opacity" Value="0"/>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsOverlayVisible}" Value="False">
                            <Setter Property="Opacity" Value="1"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>
            <TextBlock FontSize="11" Foreground="#94A3B8">
                Nhấn <Run FontWeight="Bold" Foreground="White">Ctrl + H</Run> để hiện Dashboard
            </TextBlock>
        </Border>

        <Border Background="#0F172A" BorderBrush="#334155" BorderThickness="1" CornerRadius="30" Padding="20,8"
                HorizontalAlignment="Center" VerticalAlignment="Top" Margin="0,80,0,0">
            <Border.Effect>
                <DropShadowEffect ShadowDepth="5" BlurRadius="20" Opacity="0.5"/>
            </Border.Effect>
            <Border.Style>
                <Style TargetType="Border">
                    <Setter Property="Opacity" Value="0"/>
                    <Setter Property="RenderTransform">
                        <Setter.Value>
                            <TranslateTransform Y="-20"/>
                        </Setter.Value>
                    </Setter>
                    <Style.Triggers>
                        <DataTrigger Binding="{Binding IsToastVisible}" Value="True">
                            <DataTrigger.EnterActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetProperty="Opacity" To="1" Duration="0:0:0.2"/>
                                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="0" Duration="0:0:0.2">
                                            <DoubleAnimation.EasingFunction>
                                                <CubicEase EasingMode="EaseOut"/>
                                            </DoubleAnimation.EasingFunction>
                                        </DoubleAnimation>
                                    </Storyboard>
                                </BeginStoryboard>
                            </DataTrigger.EnterActions>
                            <DataTrigger.ExitActions>
                                <BeginStoryboard>
                                    <Storyboard>
                                        <DoubleAnimation Storyboard.TargetProperty="Opacity" To="0" Duration="0:0:0.3"/>
                                        <DoubleAnimation Storyboard.TargetProperty="(UIElement.RenderTransform).(TranslateTransform.Y)" To="-20" Duration="0:0:0.3"/>
                                    </Storyboard>
                                </BeginStoryboard>
                            </DataTrigger.ExitActions>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </Border.Style>

            <StackPanel Orientation="Horizontal">
                <TextBlock Text="{Binding ToastMessage}" Foreground="#E2E8F0" FontSize="13" VerticalAlignment="Center"/>

                <Border Background="#1E293B" BorderBrush="#475569" BorderThickness="1" CornerRadius="4" Padding="6,2" Margin="10,0,0,0">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Visibility" Value="Visible"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding ToastKeyHint}" Value="">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <TextBlock Text="{Binding ToastKeyHint}" Foreground="#38BDF8" FontSize="10" FontFamily="Consolas" FontWeight="Bold"/>
                </Border>
            </StackPanel>
        </Border>

    </Grid>
</Window>